%h2.ui.block.header CircleCI builds

%table.ui.celled.table
  %thead
    %th Date
    %th Repo
    %th State
    %th Builds
    %th By Repo + Month
    %th By Month
    %th By Quarter

  %tbody
    - builds = @circleci_builds.to_a
    - builds.each.with_index do |stat, index|
      %tr
        - if index.multiple_of?(4)
          %td{ rowspan: 4 }= stat.date
        - if index.multiple_of?(2)
          %td{ rowspan: 2 }= stat.repo
        %td{ class: stat.success? ? 'positive' : 'negative' }= stat.human_state
        %td= stat.count
        - if index.multiple_of?(2)
          %td{ rowspan: 2 }
            - total = stat.count + builds[index + 1].count
            #{total} builds (#{number_to_percentage stat.count.to_f / total * 100, significant: true, precision: 2} passing)
        - if index.multiple_of?(4)
          %td{ rowspan: 4 }
            - stats = builds[index..(index + 3)]
            - successes = stats.select(&:success?).sum(&:count)
            - total = stats.sum(&:count)
            #{total} builds (#{number_to_percentage successes.to_f / total * 100, significant: true, precision: 2} passing)
        - if index.zero?
          %td{ rowspan: 12 }
            - successes = builds.select(&:success?).sum(&:count)
            - total = builds.sum(&:count)
            #{total} builds (#{number_to_percentage successes.to_f / total * 100, significant: true, precision: 2} passing)


%h2.ui.block.header Cycle time

%table.ui.collapsing.definition.table
  %thead
    %th
    %th Days
  %tbody
    %tr
      %td Mean (average)
      %td= number_with_precision @cycle_time.stats.mean
    %tr
      %td Standard deviation
      %td= number_with_precision @cycle_time.stats.standard_deviation
    %tr
      %td 90th percentile
      %td= @cycle_time.stats.percentile(90).round


%table.ui.celled.striped.small.compact.table
  %thead
    %tr
      %th Title
      %th Number
      %th Repo
      %th Started at
      %th Completed at
      %th Cycle time (days)

  %tbody
    - @cycle_time.results.each do |result|
      %tr
        %td
          = link_to "https://github.com/#{result['repo']}/issues/#{result['number']}", target: :_blank do
            = result['title'].truncate(100)
        %td= result['number']
        %td= result['repo']
        %td= l result['started_at'], format: :short
        %td= l result['ended_at'], format: :short
        %td= result['cycle_time'].round
